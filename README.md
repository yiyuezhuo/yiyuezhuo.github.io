# 一卡通数据挖掘

这个是在2015年暑假搞的，在这之前基本不会用爬虫，所以爬虫相关代码基本不能看，那时100行的事现在5行能解决。不过这个仓库还放了一些清洗过的爬取的数据。你可以在我时隔半年重构的方法使用它们，用 `pandas` 取代字典表示实质上就是dataframe的功能。

## ana_pandas_base.py

该模块具有的 `csv_load`, `unit_load` , `graph_load` , `gpa_load` 方法可以加载对应的清理过的数据（从压缩包中解压最新的）。来自川师泄露的录取信息，一卡通服务中心与教务处，主要利用泄露的信息修改密码取得，不过也有无法取得的，肯定有抽样误差。

模块加载时会自动调用以上函数，除了 `graph_load` 因为要耗时的动态计算默认不计算外。主要提取的数据放在 `unit_dt` 里，是一个`DataFrame`对象。

    unit_dt.head(5)
    
开头5项数据形如
    
                                id  level               master  money name  sex  \
    ID                                                                            
    130102199405161514  2014320331      0  2014级本科数字媒体学院数字媒体艺术  47.39  杨松楠    0   
    130102199508271214  2014320419      0  2014级本科数字媒体学院数字媒体艺术   6.98  孙博宇    0   
    130102199605040629  2014090209      0    2014级本科生命科学学院生物科学   3.70  冯青靓    0   
    130102199606161510  2014280514      0  2014级本科音乐学院音乐表演(器乐)  12.48  刘莳禹    0   
    130102199608270323  2014280214      0  2014级本科音乐学院音乐表演(声乐)  70.27  马艺菲    0   

                       statue support   gpa  school     majar class  degree  size  
    ID                                                                             
    130102199405161514    正常卡    0 /元  3.42  数字媒体学院    数字媒体艺术  美术联考       1   332  
    130102199508271214    正常卡    0 /元  3.14  数字媒体学院    数字媒体艺术  美术联考       5   332  
    130102199605040629    正常卡    0 /元  3.30  生命科学学院      生物科学    理工       8   322  
    130102199606161510    正常卡    0 /元  2.95    音乐学院  音乐表演(器乐)  器乐联考       3   410  
    130102199608270323    正常卡    0 /元  3.29    音乐学院  音乐表演(声乐)  声乐联考       6   410  
    
* degree是消费同时性计算出的朋友网络的节点的度数，`graph_load`可以指定生成网络的截断数。
* gpa就是成绩gpa
* id是学号
* index是ID，身份证号
* sex是性别，1为男，0为女
* school即所属学院

因为patsy突然抽风完全用不了了，这里实现了一套回归简便方法，核心是`regress`,使用示例

    print regress(unit_dt,y='degree',X=['gpa','size','sex'],cat=['school'],trans={'gpa':np.square}).summary()
    
输出的回归报告为
    
    drop 新闻与传播学院 for dummy variable base
                                OLS Regression Results                            
    ==============================================================================
    Dep. Variable:                 degree   R-squared:                       0.136
    Model:                            OLS   Adj. R-squared:                  0.133
    Method:                 Least Squares   F-statistic:                     44.15
    Date:                Tue, 02 Feb 2016   Prob (F-statistic):          1.49e-208
    Time:                        20:24:56   Log-Likelihood:                -26948.
    No. Observations:                7326   AIC:                         5.395e+04
    Df Residuals:                    7299   BIC:                         5.414e+04
    Df Model:                          26                                         
    Covariance Type:            nonrobust                                         
    ===============================================================================================
                                      coef    std err          t      P>|t|      [95.0% Conf. Int.]
    -----------------------------------------------------------------------------------------------
    const                          -0.7215      1.905     -0.379      0.705        -4.456     3.013
    gpa                            -0.5384      1.405     -0.383      0.702        -3.293     2.216
    size                            0.0054      0.002      2.869      0.004         0.002     0.009
    sex                            -1.7816      0.288     -6.184      0.000        -2.346    -1.217
    体育学院                   17.7201      1.071     16.538      0.000        15.620    19.820
    舞蹈学院                    2.7733      0.767      3.614      0.000         1.269     4.278
    教育科学学院             -0.3819      0.929     -0.411      0.681        -2.202     1.439
    法学院                       7.3953      1.014      7.290      0.000         5.407     9.384
    数学与软件科学学院     8.2494      0.773     10.677      0.000         6.735     9.764
    文学院                       8.4160      0.781     10.777      0.000         6.885     9.947
    政治教育学院              7.8821      1.248      6.314      0.000         5.435    10.329
    工学院                       0.8387      0.769      1.091      0.275        -0.669     2.346
    计算机科学学院           5.6471      0.792      7.134      0.000         4.095     7.199
    生命科学学院              3.4732      0.852      4.076      0.000         1.803     5.144
    音乐学院                   -0.2929      0.792     -0.370      0.712        -1.845     1.259
    美术学院                   -1.8098      0.907     -1.996      0.046        -3.588    -0.032
    外国语学院                 5.4049      0.898      6.017      0.000         3.644     7.166
    服装学院                    4.9567      3.354      1.478      0.139        -1.617    11.531
    信息技术学院              3.7469      0.751      4.989      0.000         2.275     5.219
    商学院                       6.3293      0.785      8.065      0.000         4.791     7.868
    地理与资源科学学院     3.0041      0.822      3.655      0.000         1.393     4.615
    历史文化与旅游学院     5.3051      0.865      6.136      0.000         3.610     7.000
    物理与电子工程学院     2.5582      0.750      3.410      0.001         1.087     4.029
    化学与材料科学学院     7.9044      0.764     10.352      0.000         6.408     9.401
    数字媒体学院             -0.3196      0.844     -0.379      0.705        -1.975     1.335
    经济与管理学院           4.4635      0.773      5.771      0.000         2.947     5.980
    国际教育学院              2.1870      1.642      1.332      0.183        -1.032     5.406
    square gpa                      0.5459      0.270      2.023      0.043         0.017     1.075
    ==============================================================================
    Omnibus:                     5458.247   Durbin-Watson:                   1.956
    Prob(Omnibus):                  0.000   Jarque-Bera (JB):           129600.006
    Skew:                           3.363   Prob(JB):                         0.00
    Kurtosis:                      22.477   Cond. No.                     3.59e+16
    ==============================================================================
    
    Warnings:
    [1] Standard Errors assume that the covariance matrix of the errors is correctly specified.
    [2] The smallest eigenvalue is 1.11e-24. This might indicate that there are
    strong multicollinearity problems or that the design matrix is singular.
    
被解释变量`degree`可以某种意义上看成所具有的朋友数量的度量。方程可以写成
$$
degree = \beta_0 + \beta_1 gpa + \beta_2 gpa^2 + \beta_3 size + \beta_4 sex + \beta(school) + \epsilon
$$

school是虚拟变量，控制不同学院的“固定效应”，虽然这肯定也会有异方差问题但这里先无视。size是学院的规模

我们可以看到gpa平方项是显著的，而线性项却不是显著的。sex显示了男性比女性更少社交，是符合直觉的。而我
开始设二次项是想证明与这里得到的曲线朝向相反的曲线，然而并非如此。实际上，在写这个文档时我才加入了sex变量，
它居然把gpa线性项的符号直接弄反了（当然之前也不显著）。这也许可以得出一个路径分析结论，即女性有着更高的gpa
与更多的degree，所以它把线性项拉成了正的，但在控制sex之后就并非如此了。

我们可以把degree与gpa的地位反过来回归

    print regress(unit_dt,y='gpa',X=['degree','size','sex'],cat=['school'],trans={'degree':np.square}).summary()
    
汇总报告为(y是解释变量字符串，X是直接数值变量列表，cat是分类变量，trans是以直接数值变量为key，变换函数为value的字典)

    drop 新闻与传播学院 for dummy variable base
                                OLS Regression Results                            
    ==============================================================================
    Dep. Variable:                    gpa   R-squared:                       0.329
    Model:                            OLS   Adj. R-squared:                  0.327
    Method:                 Least Squares   F-statistic:                     137.8
    Date:                Tue, 02 Feb 2016   Prob (F-statistic):               0.00
    Time:                        20:40:22   Log-Likelihood:                -4845.9
    No. Observations:                7326   AIC:                             9746.
    Df Residuals:                    7299   BIC:                             9932.
    Df Model:                          26                                         
    Covariance Type:            nonrobust                                         
    ===============================================================================================
                                      coef    std err          t      P>|t|      [95.0% Conf. Int.]
    -----------------------------------------------------------------------------------------------
    const                           2.7816      0.049     57.339      0.000         2.687     2.877
    degree                          0.0125      0.001     10.727      0.000         0.010     0.015
    size                            0.0008   8.56e-05      9.753      0.000         0.001     0.001
    sex                            -0.3918      0.013    -29.315      0.000        -0.418    -0.366
    体育学院                   -0.0043      0.053     -0.080      0.936        -0.109     0.100
    舞蹈学院                   -0.1445      0.037     -3.854      0.000        -0.218    -0.071
    教育科学学院              0.0211      0.045      0.464      0.643        -0.068     0.110
    法学院                       0.0415      0.050      0.833      0.405        -0.056     0.139
    数学与软件科学学院    -0.7126      0.036    -19.796      0.000        -0.783    -0.642
    文学院                       0.1089      0.038      2.886      0.004         0.035     0.183
    政治教育学院              0.0695      0.061      1.139      0.255        -0.050     0.189
    工学院                      -0.5039      0.037    -13.605      0.000        -0.576    -0.431
    计算机科学学院          -0.5139      0.038    -13.381      0.000        -0.589    -0.439
    生命科学学院             -0.4486      0.041    -10.814      0.000        -0.530    -0.367
    音乐学院                   -0.4279      0.038    -11.136      0.000        -0.503    -0.353
    美术学院                   -0.1957      0.041     -4.761      0.000        -0.276    -0.115
    外国语学院                 0.0536      0.044      1.216      0.224        -0.033     0.140
    服装学院                    0.0223      0.164      0.136      0.892        -0.299     0.344
    信息技术学院             -0.1681      0.037     -4.602      0.000        -0.240    -0.097
    商学院                      -0.3601      0.038     -9.412      0.000        -0.435    -0.285
    地理与资源科学学院    -0.3915      0.040     -9.777      0.000        -0.470    -0.313
    历史文化与旅游学院    -0.2506      0.042     -5.918      0.000        -0.334    -0.168
    物理与电子工程学院    -0.3880      0.036    -10.797      0.000        -0.458    -0.318
    化学与材料科学学院    -0.6577      0.037    -17.945      0.000        -0.730    -0.586
    数字媒体学院              0.1758      0.041      4.266      0.000         0.095     0.257
    经济与管理学院          -0.4190      0.038    -11.169      0.000        -0.493    -0.345
    国际教育学院              0.3835      0.080      4.788      0.000         0.227     0.541
    square degree                  -0.0001   1.88e-05     -6.936      0.000        -0.000 -9.37e-05
    ==============================================================================
    Omnibus:                      323.866   Durbin-Watson:                   1.882
    Prob(Omnibus):                  0.000   Jarque-Bera (JB):              413.946
    Skew:                          -0.461   Prob(JB):                     1.30e-90
    Kurtosis:                       3.711   Cond. No.                     4.64e+16
    ==============================================================================
    
    Warnings:
    [1] Standard Errors assume that the covariance matrix of the errors is correctly specified.
    [2] The smallest eigenvalue is 1.45e-24. This might indicate that there are
    strong multicollinearity problems or that the design matrix is singular.
    
可以发现，男性比女性平均低0.39绩点，真是个悲伤的故事。该方程解释了32.9%的方差，比上面那个好多了。这里的曲线符合我的预期，即开始degree的提升带来gpa的提升，但这种提升越来越小，直到反向（这里并没有到反向的时候）。这可以看成degree反映的学校参与度与精力损耗度的此消彼长，degree高表示对学校参与度高（相比天天去网吧的当然不会有高degree），但参与度高的同时也浪费了学习的时间，这反应在之后的下降趋势。然而我并没有数据来区分两者。

_另外我数软的系数是最小的吗。。_

我们还可以更细致的研究各个群体，如数软的情况（使用regress_test4批量报告）

    regress -> 数学与软件科学学院
                                OLS Regression Results                            
    ==============================================================================
    Dep. Variable:                    gpa   R-squared:                       0.147
    Model:                            OLS   Adj. R-squared:                  0.141
    Method:                 Least Squares   F-statistic:                     24.73
    Date:                Tue, 02 Feb 2016   Prob (F-statistic):           8.70e-15
    Time:                        20:56:00   Log-Likelihood:                -482.23
    No. Observations:                 436   AIC:                             972.5
    Df Residuals:                     432   BIC:                             988.8
    Df Model:                           3                                         
    Covariance Type:            nonrobust                                         
    =================================================================================
                        coef    std err          t      P>|t|      [95.0% Conf. Int.]
    ---------------------------------------------------------------------------------
    const             2.5511      0.060     42.254      0.000         2.432     2.670
    degree            0.0122      0.005      2.283      0.023         0.002     0.023
    sex              -0.6210      0.078     -7.990      0.000        -0.774    -0.468
    square degree    -0.0001    7.2e-05     -1.700      0.090        -0.000  1.91e-05
    ==============================================================================
    Omnibus:                       13.959   Durbin-Watson:                   1.703
    Prob(Omnibus):                  0.001   Jarque-Bera (JB):               10.263
    Skew:                          -0.267   Prob(JB):                      0.00591
    Kurtosis:                       2.471   Cond. No.                     2.86e+03
    ==============================================================================
    
    Warnings:
    [1] Standard Errors assume that the covariance matrix of the errors is correctly specified.
    [2] The condition number is large, 2.86e+03. This might indicate that there are
    strong multicollinearity or other numerical problems.
    
貌似各学院只有音乐学院有明显的gpa与degree的负相关。

## ana.py

这次重构主要把`ana.py`里类似上面分析的部分用`pandas`重构了，而网络部分（主要计算了一些同配系数来反映哪些群体（学院/性别/民族等）的封闭度。其仍然放在ana.py）

这是各种分类比较对应比例的随机模型下的偏离程度，0为完全不相关，1为分类下群体的人只与同群体的人社交。

学院分类的同配系数：0.6383015637251551
班级分类的同配系数：0.5293076610120093
性别分类的同配系数：0.6071289126859387
招生类型的同配系数：0.6684276975933798
民族分类的同配系数：0.0223383247082948
生日年份的同配系数：0.0208146912716577
省份分类的同配系数：0.0873923600643901

更多结论见那个doc文件。
